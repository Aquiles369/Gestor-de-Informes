<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="dark light">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<title>Gestor de Informes</title>
<style>
:root{
  --bg:#000000;
  --box:#000000;
  --fg:#f5f5f5;
  --muted:#888;
  --accent:#d81a0cc4;
  --pill:#000000;
  --border:#8f2626b0;
}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,Segoe UI,sans-serif;
  margin:0;
  padding:20px;
}
h1{margin:0 0 10px;font-size:24px}
.btn{
  background:var(--accent);
  border:none;
  padding:6px 12px;
  color:#000;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
.btn.ghost{
  background:var(--box);
  color:var(--fg);
  border:1px solid var(--border);
}
.btn:hover{opacity:.85}
section.category{
  background:var(--box);
  border:1px solid var(--border);
  border-radius:10px;
  margin-bottom:20px;
  padding:10px 14px;
}
.chead {
  display: flex;
  flex-wrap: wrap;            /* permite segunda fila si no entra */
  align-items: center;
  gap: 10px;
}

/* agrupa filtros y acciones dentro de la misma ‚Äúl√≠nea l√≥gica‚Äù */
.cfilters, .cactions {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

/* que los filtros no se expandan de m√°s */
.cfilters {
  flex-shrink: 0;
}

/* que las acciones se mantengan pegadas a la derecha */
.cactions {
  flex-grow: 1;
  justify-content: flex-start;  /* todos alineados en serie */
}

.ctitle{margin:0;font-size:20px;cursor:pointer}
.cfilters{display:flex;gap:6px;align-items:center}
.cfilter-select,.cfilter-input{
  background:var(--box);
  color:var(--fg);
  border:1px solid var(--border);
  border-radius:6px;
  padding:4px 8px;
}
.cactions{display:flex;gap:6px;flex-wrap:wrap}
.items{margin-top:10px;display:flex;flex-direction:column;gap:6px}
.item{
  background:#000000;
  border:1px solid var(--border);
  padding:6px 10px;
  border-radius:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}
.item.note{border-color:var(--accent)}
.row-left{display:flex;align-items:center;gap:8px;flex-shrink:0}
.ititle{font-weight:600;cursor:pointer}
.linkbox{flex-grow:1;display:flex;gap:6px}
.ipayload{
  flex-grow:1;
  background:#941b1ba2;
  color:var(--fg);
  border:1px solid var(--border);
  border-radius:6px;
  padding:4px 8px;
}
.pill{
  background:var(--pill);
  color:var(--fg);
  border:none;
  border-radius:20px;
  padding:2px 10px;
  font-size:12px;
  cursor:pointer;
}
.pill-none{background:#333}
.pill-monton{background:#4b434e;color:#000000}
.pill-regular{background:#bdc00da9;color:#000000}
.pill-buen{background:#02c0f0;color:#000000}
.pill-muybueno{background:rgb(16, 151, 50);color:#000000}
.pill-excelente{background:rgba(255, 0, 0, 0.692);color:#000}
.pill-urgente{background:rgba(190, 178, 13, 0.829);color:#000000}
.pill-luego{background:#79278aa8;color:#000}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;
}
.modal.open{display:flex}
.modal .box{
  background:var(--box);
  color:var(--fg);
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:600px;
}
.note-wrap textarea{
  width:100%;
  min-height:160px;
  background:#7a1f1f75;
  color:var(--fg);
  border:1px solid var(--border);
  border-radius:6px;
  padding:8px;
  resize:vertical;
}
.label-menu{
  position:fixed;
  background:var(--box);
  border:1px solid var(--border);
  border-radius:6px;
  list-style:none;
  margin:0;
  padding:4px;
  z-index:1000;
}
.label-menu li{
  padding:3px 6px;
  cursor:pointer;
}
.label-menu li:hover{background:#222}
#tooltip{
  position:fixed;
  background:#000000;
  color:#fff;
  padding:6px 8px;
  border-radius:6px;
  font-size:12px;
  max-width:280px;
  z-index:2000;
  pointer-events:none;
  display:none;
}
#tooltip.show{display:block}
#tooltip .tt-title{font-weight:700;margin-bottom:3px}
#tooltip .tt-meta{margin-top:3px;color:#701111;font-size:11px}
.actions{display:flex;gap:6px;margin-top:10px}


/* Hace que el encabezado de cada categor√≠a quede fijo cuando se hace scroll */
section.category {
  position: relative;
}

section.category .chead {
  position: sticky;
  top: 0;
  z-index: 50;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  padding: 10px 14px;
}


/* Sombra sutil cuando el header se queda pegado */
section.category .chead::after {
  content: "";
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 6px;
  background: linear-gradient(to bottom, rgba(0,0,0,.5), transparent);
  pointer-events: none;
}




/* ======= LIMPIEZA TOTAL DE BOTONES ======= */
button,
.btn,
input[type="button"],
input[type="submit"],
input[type="reset"] {
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
  background: var(--accent);
  color: #fff;
  font-weight: 500;
  border-radius: 4px;
  transition: background 0.2s;
  cursor: pointer;
}

/* Hover simple, sin efectos extra */
button:hover,
.btn:hover,
input[type="button"]:hover,
input[type="submit"]:hover,
input[type="reset"]:hover {
  background: #a11;
}

/* Botones secundarios, sin bordes ni sombras */
button.secondary,
.btn-secondary {
  background: rgba(255,255,255,0.05);
  color: #ddddddad;
  border: none !important;
  box-shadow: none !important;
}

button.secondary:hover,
.btn-secondary:hover {
  background: rgba(255,255,255,0.12);
  color: #fff;
}

/* Asegura que nada se vea con borde al hacer foco */
button:focus,
.btn:focus {
  outline: none !important;
  box-shadow: none !important;
}



/* Quita el fondo rojo a los botones de cabecera */
.cactions .btn {
  background: rgba(255, 255, 255, 0.05);  /* fondo oscuro neutro */
  color: #ddd;
  border: none;
}

.cactions .btn:hover {
  background: rgba(255, 255, 255, 0.12);  /* hover sutil */
  color: #fff;
}



/* ==== AJUSTE DE CAPAS DEL MODAL ==== */

/* Fondo oscuro del modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998 !important; /* capa del fondo */
}

/* Contenedor visible (cuadro negro con texto) */
.modal.open {
  display: flex;
}

/* Caja interna (el bloque que muestra el contenido) */
.modal .box {
  position: relative;
  background: var(--box);
  color: var(--fg);
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 600px;
  z-index: 9999 !important; /* capa superior: por encima del fondo */
  box-shadow: 0 0 25px rgba(0,0,0,0.8);
}

/* Previene que el resto del contenido se superponga */
body.modal-open {
  overflow: hidden;
}



/* ==== EFECTO HOVER ROJO EN BOTONES PRINCIPALES ==== */

/* Aplica a todos los botones del header/categor√≠as */
.cactions button,
.cactions .btn {
  transition: background 0.2s ease, color 0.2s ease;
}

/* Hover rojo brillante */
.cactions button:hover,
.cactions .btn:hover {
  background: #b00 !important;
  color: #fff !important;
}

/* Opcional: si quer√©s un leve cambio de cursor */
.cactions button:hover,
.cactions .btn:hover {
  cursor: pointer;
}

/* Asegura que no haya bordes extra al pasar el mouse */
.cactions button,
.cactions .btn {
  border: none !important;
  box-shadow: none !important;
}



</style>
</head>
<body>
<center> <h1>ü¶Ö Gestor de Informes ü¶Ö</h1> </center>
<br><br>
<div id="cats"></div>

<!-- Modal de notas -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mod-title">
  <div class="box">
    <center><h2 id="mod-title">ü¶Ö</h2></center>
    <center><p id="mod-msg">Tus notas personales en solo lugar</p></center>
    <div class="note-wrap">
      <label id="noteLabel" for="noteArea">ü¶Ö</label>
      <textarea id="noteArea" placeholder="Tips, cadenas, CSP, contextos, mutaciones‚Ä¶"></textarea>
      <p id="metaInfo" style="font-size:12px;color:var(--muted);margin:6px 0 0"></p>
    </div>
    <div class="actions">
      <button id="saveNote" class="btn">Guardar (Ctrl+S)</button>
      <button id="clearNote" class="btn ghost">Borrar nota</button>
      <button id="close" class="btn ghost">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de carga masiva -->
<div id="bulkModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bulk-title">
  <div class="box">
    <center><h2 id="bulk-title">Carga masiva de informes</h2></center>
    <center><p class="sub" style="margin:0 0 10px">Peg√° <b>una URL por l√≠nea</b>.</p></center>
    <div class="note-wrap">
      <label for="bulkArea">Lista de URLs</label>
      <textarea id="bulkArea" placeholder="https://example.com/report/123"></textarea>
      <label><input id="bulkTrimEmpty" type="checkbox" checked> Ignorar l√≠neas vac√≠as</label>
    </div>
    <div class="actions">
      <button id="bulkCreate" class="btn">Crear (Ctrl+Enter)</button>
      <button id="bulkCancel" class="btn ghost">Cancelar</button>
    </div>
  </div>
</div>

<div id="tooltip" role="tooltip" aria-hidden="true"></div>

<script>
(function(){
  const KEY = 'aquiles_payloads_data_v1';
  const UIKEY = 'aquiles_payloads_ui_filters_v1';
  const catsEl = document.getElementById('cats');

  function uid(){ return Math.random().toString(36).slice(2,9); }
  function load(){
    try{ const o = JSON.parse(localStorage.getItem(KEY)||''); if(o && Array.isArray(o.cats)) return o; }catch{}
    return { cats:[{id:uid(),title:'XSS',items:[]},{id:uid(),title:'IDOR',items:[]},{id:uid(),title:'RCE',items:[]}] };
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  let state = load();

  // filtros
  let filters = loadFilters();
  function loadFilters(){ try{ return JSON.parse(localStorage.getItem(UIKEY)||'{}'); }catch{ return {}; } }
  function getFilter(catId){ return filters[catId] || { text:'', state:'all' }; }
  function setFilter(catId, patch){
    filters[catId] = { ...getFilter(catId), ...patch };
    localStorage.setItem(UIKEY, JSON.stringify(filters));
    render();
  }

  // estados
  const STATUS_SET = [
    {id:'monton',text:'Informe del mont√≥n',cls:'pill-monton'},
    {id:'regular',text:'Informe regular',cls:'pill-regular'},
    {id:'buen',text:'Informe bueno',cls:'pill-buen'},
    {id:'muybueno',text:'Informe muy bueno',cls:'pill-muybueno'},
    {id:'excelente',text:'Informe excelente',cls:'pill-excelente'},
    {id:'urgente',text:'Leer inmediatamente',cls:'pill-urgente'},
    {id:'luego',text:'Leer m√°s tarde',cls:'pill-luego'}
  ];
  function statusObj(id){ return STATUS_SET.find(s=>s.id===id)||null; }

  // tooltip
  const $tt = document.getElementById('tooltip');
  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function tipHtml(item){
    const title=escapeHtml(item.title||'Informe');
    const body=(item.note||'').trim()?escapeHtml(item.note).replace(/\n/g,'<br>'):'<i>Sin nota</i>';
    const meta=item.editedTs?`<div class="tt-meta">√öltima edici√≥n: ${new Date(item.editedTs).toLocaleString()}</div>`:'';
    return `<div class="tt-title">${title}</div><div class="tt-body">${body}</div>${meta}`;
  }
  function showTip(html,x,y){$tt.innerHTML=html;$tt.classList.add('show');positionTip(x,y);$tt.setAttribute('aria-hidden','false');}
  function moveTip(x,y){if($tt.classList.contains('show'))positionTip(x,y);}
  function hideTip(){$tt.classList.remove('show');$tt.setAttribute('aria-hidden','true');}
  function positionTip(x,y){
    const pad=10,off=16,mw=$tt.offsetWidth,mh=$tt.offsetHeight;
    let left=x+off,top=y+off;
    if(left+mw>innerWidth-pad)left=x-mw-off;if(left<pad)left=pad;
    if(top+mh>innerHeight-pad)top=y-mh-off;if(top<pad)top=pad;
    $tt.style.left=left+'px';$tt.style.top=top+'px';
  }
  function bindNoteTooltip(el,item){
    el.addEventListener('mouseenter',e=>showTip(tipHtml(item),e.clientX,e.clientY));
    el.addEventListener('mousemove',e=>moveTip(e.clientX,e.clientY));
    el.addEventListener('mouseleave',hideTip);
  }

  // helpers
  function getCI(catId,itemId){
    const cat=state.cats.find(c=>c.id===catId);
    const item=cat?cat.items.find(i=>i.id===itemId):null;
    return {cat,item};
  }
  function selectAll(el){const r=document.createRange();r.selectNodeContents(el);const s=window.getSelection();s.removeAllRanges();s.addRange(r);}

  // urls
  function toHttpUrl(v){
    const s=(v||'').trim();if(!s)return null;
    try{const withProto=/^https?:\/\//i.test(s)?s:'http://'+s;const u=new URL(withProto);return u.href;}catch{return null;}
  }
  function openOne(urlStr){
    const u=toHttpUrl(urlStr);if(!u){alert('URL inv√°lida o vac√≠a.');return false;}
    window.open(u,'_blank','noopener,noreferrer');return true;
  }

  // render
  function render(){
    catsEl.innerHTML='';
    state.cats.forEach(cat=>{
      const wrap=document.createElement('section');wrap.className='category';wrap.dataset.id=cat.id;
      const head=document.createElement('div');head.className='chead';
      const title=document.createElement('h2');title.className='ctitle';
      title.textContent=cat.title+' ('+(cat.items?.length||0)+')';
      title.title='Doble click para editar';
      title.addEventListener('dblclick',()=>editCatTitle(title,cat));

      const fwrap=document.createElement('div');fwrap.className='cfilters';
      const fState=document.createElement('select');fState.className='cfilter-select';
      fState.innerHTML=`<option value="all">Estado: todos</option><option value="none">Sin etiqueta</option>${STATUS_SET.map(s=>`<option value="${s.id}">${s.text}</option>`).join('')}`;
      const curF=getFilter(cat.id);fState.value=curF.state;
      fState.addEventListener('change',()=>setFilter(cat.id,{state:fState.value}));
      const fText=document.createElement('input');fText.className='cfilter-input';fText.placeholder='Filtrar por texto‚Ä¶';
      fText.value=curF.text;fText.addEventListener('input',()=>setFilter(cat.id,{text:fText.value.trim().toLowerCase()}));
      fwrap.append(fState,fText);

      const actions=document.createElement('div');actions.className='cactions';
      // Botones de acciones dentro de cada categor√≠a
const addCatBtn = btn('+ Nueva categor√≠a', addCategory); // ‚Üê agregado aqu√≠
const delCatBtn = btn('Eliminar categor√≠a', () => delCat(cat.id), true);
const addItemBtn = btn('+ Agregar', () => addItem(cat.id));
const bulkBtn = btn('Carga masiva', () => openBulk(cat.id));
const copyUrlsBtn = btn('Copiar URLs', () => copyUrls(cat.id), true);
const copyNotesBtn = btn('Copiar Notas', () => copyNotes(cat.id), true);
const exportBtn = btn('Exportar JSON', () => exportCat(cat.id), true);
const importBtn = btn('Importar JSON', () => importCat(cat.id), true);

// Orden: Nueva categor√≠a primero, luego Agregar, etc.
actions.append(addCatBtn, delCatBtn, addItemBtn, bulkBtn, copyUrlsBtn, copyNotesBtn, exportBtn, importBtn, );

      head.append(title,fwrap,actions);wrap.appendChild(head);

      const list=document.createElement('div');list.className='items';
      const flt=getFilter(cat.id);
      const visible=(cat.items||[]).filter(it=>matchItem(it,flt));
      visible.forEach(item=>{
        const row=document.createElement('div');row.className='item';row.dataset.item=item.id;
        if((item.note||'').trim())row.classList.add('note');

        const left=document.createElement('div');left.className='row-left';
        const ititle=document.createElement('div');ititle.className='ititle';ititle.textContent=item.title||'Nuevo informe';
        ititle.addEventListener('click',e=>{e.stopPropagation();editItemTitle(ititle,cat.id,item.id);});
        const pill=renderStatusPill(cat.id,item.id);left.append(ititle,pill);

        const linkB=document.createElement('div');linkB.className='linkbox';
        const ipayload=document.createElement('input');ipayload.className='ipayload';ipayload.type='text';ipayload.placeholder='URL del informe';
        ipayload.value=item.payload||'';ipayload.addEventListener('change',()=>{item.payload=ipayload.value;save();});
        const openBtn=document.createElement('button');openBtn.className='btn open';openBtn.textContent='Abrir';
        openBtn.addEventListener('click',()=>{const v=(item.payload||'').trim();if(!v){alert('Sin URL');return;}openOne(v);});
        linkB.append(ipayload,openBtn);

        const tools=document.createElement('div');tools.style.display='flex';tools.style.gap='6px';
        const noteBtn=btn('Nota',()=>openNote(cat.id,item.id),false);
        const delBtn=btn('Borrar',()=>delItem(cat.id,item.id),true);
        tools.append(noteBtn,delBtn);

        row.append(left,linkB,tools);
        bindNoteTooltip(row,item);bindNoteTooltip(noteBtn,item);
        row.addEventListener('click',e=>{
          const t=e.target.tagName.toLowerCase();
          if(['input','button','a'].includes(t)||e.target.classList.contains('pill')||e.target.classList.contains('ititle'))return;
          openNote(cat.id,item.id);
        });
        list.appendChild(row);
      });
      wrap.appendChild(list);catsEl.appendChild(wrap);
    });
  }

  function matchItem(item,flt){
    const textOk=!flt.text||(`${item.title} ${item.payload||''} ${item.note||''}`).toLowerCase().includes(flt.text);
    const stateOk=flt.state==='all'?true:flt.state==='none'?!item.status:item.status===flt.state;
    return textOk&&stateOk;
  }
  function btn(txt,fn,ghost=false){const b=document.createElement('button');b.className='btn'+(ghost?' ghost':'');b.textContent=txt;b.onclick=fn;return b;}

  function renderStatusPill(catId,itemId){
    const {item}=getCI(catId,itemId);
    const s=statusObj(item.status);
    const btn=document.createElement('button');btn.className='pill '+(s?s.cls:'pill-none');
    btn.textContent=s?s.text:'Estado';
    btn.onclick=e=>openStatusMenu(btn,catId,itemId);
    return btn;
  }
  function openStatusMenu(anchor,catId,itemId){
    closeMenus();
    const menu=document.createElement('ul');menu.className='label-menu';
    const add=(id,text,cls)=>{const li=document.createElement('li');li.innerHTML=`<span class="pill ${cls}">${text}</span>`;li.onclick=()=>{setStatus(catId,itemId,id);closeMenus();};menu.appendChild(li);};
    add(null,'Sin etiqueta','pill-none');STATUS_SET.forEach(s=>add(s.id,s.text,s.cls));
    document.body.appendChild(menu);
    requestAnimationFrame(()=>{const r=anchor.getBoundingClientRect();menu.style.left=r.left+'px';menu.style.top=r.bottom+'px';});
    document.addEventListener('mousedown',e=>{if(!menu.contains(e.target)&&e.target!==anchor)closeMenus();},{once:true});
  }
  function closeMenus(){document.querySelectorAll('.label-menu').forEach(m=>m.remove());}
  function setStatus(catId,itemId,status){const {item}=getCI(catId,itemId);if(!item)return;item.status=status||null;save();render();}

  function editCatTitle(el,cat){
    el.contentEditable='true';el.focus();selectAll(el);
    el.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();el.blur();}};
    el.onblur=()=>{cat.title=(el.textContent||'').replace(/\(\d+\)\s*$/,'').trim()||'Sin nombre';save();render();};
  }
  function editItemTitle(el,catId,itemId){
    const {item}=getCI(catId,itemId);if(!item)return;
    el.contentEditable='true';el.focus();selectAll(el);
    el.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();el.blur();}};
    el.onblur=()=>{item.title=(el.textContent||'').trim()||'Nuevo informe';save();render();};
  }

  function addCategory(){const name=prompt('Nombre de la categor√≠a:','Nueva categor√≠a');if(name===null)return;
    state.cats.push({id:uid(),title:name.trim()||'Nueva categor√≠a',items:[]});save();render();}
  function delCat(catId){if(!confirm('¬øEliminar categor√≠a completa?'))return;
    state.cats=state.cats.filter(c=>c.id!==catId);save();render();}
  function addItem(catId){const cat=state.cats.find(c=>c.id===catId);if(!cat)return;
    cat.items.push({id:uid(),title:'Nuevo informe',payload:'',note:'',editedTs:0,status:null});save();render();}
  function delItem(catId,itemId){const cat=state.cats.find(c=>c.id===catId);if(!cat)return;
    cat.items=cat.items.filter(i=>i.id!==itemId);save();render();}

  // notas
  const $modal=document.getElementById('modal');
  const $noteArea=document.getElementById('noteArea');
  const $metaInfo=document.getElementById('metaInfo');
  const $saveNote=document.getElementById('saveNote');
  const $clearNote=document.getElementById('clearNote');
  const $close=document.getElementById('close');
  let active={catId:null,itemId:null};

  function openNote(catId,itemId){
    const {item}=getCI(catId,itemId);if(!item)return;
    active={catId,itemId};
    document.getElementById('mod-title').textContent='  '+(item.title||'Informe');
    document.getElementById('noteLabel').textContent='ü¶Ö '+(item.title||'Informe');
    $noteArea.value=item.note||'';
    $metaInfo.textContent=item.editedTs?('√öltima edici√≥n: '+new Date(item.editedTs).toLocaleString()):'‚Äî';
    $modal.classList.add('open');hideTip();setTimeout(()=>{$noteArea.focus();},0);
  }
  function closeNote(){$modal.classList.remove('open');}
  $saveNote.onclick=()=>{const {item}=getCI(active.catId,active.itemId);if(!item)return;
    item.note=$noteArea.value.trim();item.editedTs=Date.now();save();closeNote();render();};
  $clearNote.onclick=()=>{if(!confirm('¬øBorrar nota?'))return;
    const {item}=getCI(active.catId,active.itemId);if(!item)return;
    item.note='';item.editedTs=0;save();closeNote();render();};
  $close.onclick=closeNote;
  $modal.onclick=e=>{if(e.target===$modal)closeNote();};
  window.addEventListener('keydown',e=>{if($modal.classList.contains('open')){if(e.key==='Escape')closeNote();if(e.ctrlKey&&e.key.toLowerCase()==='s'){e.preventDefault();$saveNote.click();}}});

  // carga masiva
  const $bulkModal=document.getElementById('bulkModal');
  const $bulkArea=document.getElementById('bulkArea');
  const $bulkTrimEmpty=document.getElementById('bulkTrimEmpty');
  const $bulkCreate=document.getElementById('bulkCreate');
  const $bulkCancel=document.getElementById('bulkCancel');
  let bulkTargetCatId=null;
  function openBulk(catId){bulkTargetCatId=catId;$bulkArea.value='';$bulkModal.classList.add('open');setTimeout(()=>{$bulkArea.focus();},0);}
  function closeBulk(){$bulkModal.classList.remove('open');bulkTargetCatId=null;}
  $bulkCancel.onclick=closeBulk;
  $bulkCreate.onclick=doBulkCreate;
  window.addEventListener('keydown',e=>{if($bulkModal.classList.contains('open')&&e.ctrlKey&&e.key.toLowerCase()==='enter'){e.preventDefault();doBulkCreate();}});
  function doBulkCreate(){
    const cat=state.cats.find(c=>c.id===bulkTargetCatId);if(!cat){closeBulk();return;}
    let lines=$bulkArea.value.replace(/\r/g,'\n').split('\n');
    if($bulkTrimEmpty.checked)lines=lines.map(l=>l.trim()).filter(l=>l.length>0);
    if(!lines.length){alert('No hay l√≠neas');return;}
    const toCreate=lines.slice(0,5000);
    toCreate.forEach((payload,idx)=>{
      cat.items.push({id:uid(),title:`Informe ${idx+1}`,payload:payload,note:'',editedTs:0,status:null});
    });
    save();closeBulk();render();alert(`Creados ${toCreate.length} informes en "${cat.title}".`);
  }

  // copiar
  function copyUrls(catId){const cat=state.cats.find(c=>c.id===catId);if(!cat)return;
    const flt=getFilter(cat.id);
    const vals=(cat.items||[]).filter(i=>matchItem(i,flt)).map(i=>(i.payload||'').trim()).filter(u=>u.length>0);
    navigator.clipboard.writeText(vals.join('\n'));alert(`Copiadas ${vals.length} URLs de "${cat.title}".`);}
  function copyNotes(catId){const cat=state.cats.find(c=>c.id===catId);if(!cat)return;
    const flt=getFilter(cat.id);
    const vals=(cat.items||[]).filter(i=>matchItem(i,flt)).map(i=>(i.note||'').trim()).filter(u=>u.length>0);
    navigator.clipboard.writeText(vals.join('\n'));alert(`Copiadas ${vals.length} notas de "${cat.title}".`);}

  // export/import
  function exportCat(catId){
    const cat=state.cats.find(c=>c.id===catId);if(!cat)return;
    const blob=new Blob([JSON.stringify(cat,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${cat.title}.json`;a.click();
  }
  function importCat(catId){
    const inp=document.createElement('input');inp.type='file';inp.accept='.json,application/json';
    inp.onchange=e=>{
      const file=e.target.files[0];if(!file)return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const data=JSON.parse(reader.result);
          const cat=state.cats.find(c=>c.id===catId);
          if(!cat||!Array.isArray(data.items))throw new Error();
          cat.items=data.items;save();render();
          alert(`Importados ${data.items.length} informes en "${cat.title}".`);
        }catch{alert('Archivo inv√°lido.');}
      };
      reader.readAsText(file);
    };
    inp.click();
  }

  render();
})();
</script>
</body>
</html>
