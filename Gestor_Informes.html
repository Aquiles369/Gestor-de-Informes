<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="dark light">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<title>Gestor de Informes</title>
<style>
:root{
  --bg:#000000;
  --box:#000000;
  --fg:#f5f5f5;
  --muted:#888888;
  --accent:#e71d0fbd;
  --pill:#000000;
  --border:#693737f1;
}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,Segoe UI,sans-serif;
  margin:0;
  padding:20px;
}
h1{margin:0 0 10px;font-size:24px}
.btn{
  background:var(--accent);
  border:none;
  padding:6px 12px;
  color:#ce1616;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
.btn.ghost{
  background:var(--box);
  color:var(--fg);
  border:1px solid var(--border);
}
.btn:hover{opacity:.85}
section.category{
  background:var(--box);
  border:1px solid var(--border);
  border-radius:10px;
  margin-bottom:20px;
  padding:10px 14px;
}
.chead {
  display: flex;
  flex-wrap: wrap;            /* permite segunda fila si no entra */
  align-items: center;
  gap: 10px;
}

/* agrupa filtros y acciones dentro de la misma ‚Äúl√≠nea l√≥gica‚Äù */
.cfilters, .cactions {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

/* que los filtros no se expandan de m√°s */
.cfilters {
  flex-shrink: 0;
}

/* que las acciones se mantengan pegadas a la derecha */
.cactions {
  flex-grow: 1;
  justify-content: flex-start;  /* todos alineados en serie */
}

.ctitle{margin:0;font-size:20px;cursor:pointer}
.cfilters{display:flex;gap:6px;align-items:center}
.cfilter-select,.cfilter-input{
  background:var(--box);
  color:var(--fg);
  border:1px solid var(--border);
  border-radius:6px;
  padding:4px 8px;
}
.cactions{display:flex;gap:6px;flex-wrap:wrap}
.items{margin-top:10px;display:flex;flex-direction:column;gap:6px}
.item{
  background:#000000;
  border:1px solid var(--border);
  padding:6px 10px;
  border-radius:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}
.item.note{border-color:var(--accent)}
.row-left{display:flex;align-items:center;gap:8px;flex-shrink:0}
.ititle{font-weight:600;cursor:pointer}
.linkbox{flex-grow:1;display:flex;gap:6px}
.ipayload{
  flex-grow:1;
  background:#b3101069;
  color:var(--fg);
  border:1px solid var(--border);
  border-radius:10px;
  padding:4px 8px;
}
.pill{
  background:var(--pill);
  color:var(--fg);
  border:none;
  border-radius:20px;
  padding:2px 10px;
  font-size:12px;
  cursor:pointer;
}
.pill-none{background:#333}
.pill-monton{background:#faf9fa;color:#050505}
.pill-regular{background:#bdc00da9;color:#000000}
.pill-buen{background:#02c0f0;color:#000000}
.pill-muybueno{background:rgb(16, 151, 50);color:#000000}
.pill-excelente{background:rgba(255, 0, 0, 0.692);color:#000}
.pill-urgente{background:rgba(213, 112, 11, 0.829);color:#000000}
.pill-luego{background:#ad10cca8;color:#f1eded}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;
}
.modal.open{display:flex}
.modal .box{
  background:var(--box);
  color:var(--fg);
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:600px;
}
.note-wrap textarea{
  width:100%;
  min-height:160px;
  background:#7a1f1f75;
  color:var(--fg);
  border:1px solid var(--border);
  border-radius:6px;
  padding:8px;
  resize:vertical;
}
.label-menu{
  position:fixed;
  background:var(--box);
  border:1px solid var(--border);
  border-radius:6px;
  list-style:none;
  margin:0;
  padding:4px;
  z-index:1000;
}
.label-menu li{
  padding:3px 6px;
  cursor:pointer;
}
.label-menu li:hover{background:#222}
#tooltip{
  position:fixed;
  background:#000000;
  color:#fff;
  padding:6px 8px;
  border-radius:6px;
  font-size:12px;
  max-width:280px;
  z-index:2000;
  pointer-events:none;
  display:none;
}
#tooltip.show{display:block}
#tooltip .tt-title{font-weight:700;margin-bottom:3px}
#tooltip .tt-meta{margin-top:3px;color:#dd0f0f;font-size:11px}
.actions{display:flex;gap:6px;margin-top:10px}


/* Hace que el encabezado de cada categor√≠a quede fijo cuando se hace scroll */
section.category {
  position: relative;
}

section.category .chead {
  position: sticky;
  top: 0;
  z-index: 50;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  padding: 10px 14px;
}


/* Sombra sutil cuando el header se queda pegado */
section.category .chead::after {
  content: "";
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 6px;
  background: linear-gradient(to bottom, rgba(0,0,0,.5), transparent);
  pointer-events: none;
}




/* ======= LIMPIEZA TOTAL DE BOTONES ======= */
button,
.btn,
input[type="button"],
input[type="submit"],
input[type="reset"] {
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
  background: var(--accent);
  color: #fff;
  font-weight: 500;
  border-radius: 4px;
  transition: background 0.2s;
  cursor: pointer;
}

/* Hover simple, sin efectos extra */
button:hover,
.btn:hover,
input[type="button"]:hover,
input[type="submit"]:hover,
input[type="reset"]:hover {
  background: rgba(197, 14, 14, 0.787);
}

/* Botones secundarios, sin bordes ni sombras */
button.secondary,
.btn-secondary {
  background: rgba(255,255,255,0.05);
  color: #ddddddad;
  border: none !important;
  box-shadow: none !important;
}

button.secondary:hover,
.btn-secondary:hover {
  background: rgba(255,255,255,0.12);
  color: #fff;
}

/* Asegura que nada se vea con borde al hacer foco */
button:focus,
.btn:focus {
  outline: none !important;
  box-shadow: none !important;
}



/* Quita el fondo rojo a los botones de cabecera */
.cactions .btn {
  background: rgba(255, 255, 255, 0.05);  /* fondo oscuro neutro */
  color: #ddd;
  border: none;
}

.cactions .btn:hover {
  background: rgba(255, 255, 255, 0.12);  /* hover sutil */
  color: #fff;
}



/* ==== AJUSTE DE CAPAS DEL MODAL ==== */

/* Fondo oscuro del modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998 !important; /* capa del fondo */
}

/* Contenedor visible (cuadro negro con texto) */
.modal.open {
  display: flex;
}

/* Caja interna (el bloque que muestra el contenido) */
.modal .box {
  position: relative;
  background: var(--box);
  color: var(--fg);
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 600px;
  z-index: 9999 !important; /* capa superior: por encima del fondo */
  box-shadow: 0 0 25px rgba(0,0,0,0.8);
}

/* Previene que el resto del contenido se superponga */
body.modal-open {
  overflow: hidden;
}



/* ==== EFECTO HOVER ROJO EN BOTONES PRINCIPALES ==== */

/* Aplica a todos los botones del header/categor√≠as */
.cactions button,
.cactions .btn {
  transition: background 0.2s ease, color 0.2s ease;
}

/* Hover rojo brillante */
.cactions button:hover,
.cactions .btn:hover {
  background: #b00 !important;
  color: #fff !important;
}

/* Opcional: si quer√©s un leve cambio de cursor */
.cactions button:hover,
.cactions .btn:hover {
  cursor: pointer;
}

/* Asegura que no haya bordes extra al pasar el mouse */
.cactions button,
.cactions .btn {
  border: none !important;
  box-shadow: none !important;
}


/* ===== SCROLL INDEPENDIENTE PARA AUDIOS E IM√ÅGENES ===== */
#audioList, #imageList {
  max-height: 240px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px;
  background: rgba(255,255,255,0.02);
}

/* Est√©tica del scrollbar */
#audioList::-webkit-scrollbar,
#imageList::-webkit-scrollbar {
  width: 8px;
}
#audioList::-webkit-scrollbar-thumb,
#imageList::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}
#audioList::-webkit-scrollbar-thumb:hover,
#imageList::-webkit-scrollbar-thumb:hover {
  background: #b00;
}

/* ===== MODAL DE IMAGEN AMPLIADA ===== */
#imgViewer {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}
#imgViewer.open { display: flex; }
#imgViewer img {
  max-width: 90%;
  max-height: 90%;
  border: 3px solid #b00;
  border-radius: 10px;
}
#imgViewer button {
  position: absolute;
  top: 16px;
  right: 20px;
  background: #b00;
  color: #fff;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
#imgViewer button:hover {
  background: #e33;
}


/* ==== BOT√ìN "CERRAR" ARRIBA A LA DERECHA DEL MODAL DE NOTAS ==== */
#modal .box {
  position: relative;
}

#modal .close-note-btn {
  position: absolute;
  top: 10px;
  right: 12px;
  background: #b00;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 4px 10px;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.2s ease;
  z-index: 10;
}

#modal .close-note-btn:hover {
  background: #e33;
}



/* ==== ALINEACI√ìN EXACTA ENTRE AUDIOS Y CAPTURAS ==== */
.media-section {
  display: flex;
  gap: 12px;
  justify-content: space-between;
  align-items: flex-start;
}

.media-section > div {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

#audioList, #imageList {
  box-sizing: border-box;
}



/* ==== MODAL RESPONSIVO Y ADAPTABLE ==== */
#modal .box {
  display: flex;
  flex-direction: column;
  max-height: 95vh;          /* evita desbordar pantalla */
  overflow-y: auto;          /* scroll interno si hay exceso */
  width: 95%;
  max-width: 800px;          /* un poco m√°s ancho para pantallas grandes */
  box-sizing: border-box;
}

#modal .note-wrap textarea {
  min-height: 160px;
  max-height: 45vh;          /* altura flexible */
  resize: vertical;
}

@media (max-width: 700px) {
  #modal .box {
    padding: 14px;
    max-width: 95%;
  }
  .media-section {
    flex-direction: column;  /* apila audio e im√°genes */
  }
}




/* ==== CENTRAR BOTONES DE ACCIONES EN MODAL ==== */
#modal .actions {
  display: flex;
  justify-content: center; /* centra horizontalmente */
  align-items: center;
  gap: 12px;                /* separa los botones */
  margin-top: 18px;
}



#modal .actions .btn {
  min-width: 80px;
  padding: 8px 12px;
  font-size: 13px;
  border-radius: 5px;
}



#videoList {
  max-height: 240px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px;
  background: rgba(255,255,255,0.02);
}
#videoList::-webkit-scrollbar {
  width: 8px;
}
#videoList::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}
#videoList::-webkit-scrollbar-thumb:hover {
  background: #b00;
}




/* ==== Quita el fondo rojo del bot√≥n ‚ÄúAbrir‚Äù del header ==== */
.cfilters .btn {
  background: rgba(255, 255, 255, 0.05) !important;
  color: #ddd !important;
  border: none !important;
}

.cfilters .btn:hover {
  background: rgba(215, 13, 13, 0.887) !important;
  color: #fff !important;
}




</style>
</head>
<body>
<center> <h1>ü¶Ö Gestor de Informes ü¶Ö</h1> </center>
<br><br>

<div id="cats"></div>




<!-- Modal de notas -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mod-title">
  <div class="box">
    <center><h2 id="mod-title">ü¶Ö</h2></center>
    <center><p id="mod-msg"> ï¬∑Õ°·¥•¬∑ î (Õ†‚âñ Õú ñÕ†‚âñ) 	‡ºº „Å§ ‚óï_‚óï ‡ºΩ„Å§ (Õ†‚âñ Õú ñÕ†‚âñ)   ï¬∑Õ°·¥•¬∑ î</p></center>
    <div class="note-wrap">
      <label id="noteLabel" for="noteArea">ü¶Ö</label>
      <textarea id="noteArea" placeholder="Tips, cadenas, contextos"></textarea>
      <p id="metaInfo" style="font-size:12px;color:var(--muted);margin:6px 0 0"></p>
    </div>
    <!-- Bot√≥n de cerrar arriba a la derecha -->
<button id="close" class="close-note-btn">cerrar</button>

<div class="actions">
  <button id="saveNote" class="btn">Guardar (Ctrl+S)</button>
  <button id="clearNote" class="btn ghost">Borrar nota</button>
</div>


  <div class="media-section" style="display:flex;gap:12px;justify-content:space-between;margin-top:12px;">
    <div style="flex:1;">
      <center> <h4>üó£ Audios üó£</h4></center>
      <center><button id="recordAudio" class="btn ghost" style="margin-bottom:8px;">Grabar Audio</button></center>
      <div id="audioList"></div>
    </div>
    <div style="flex:1;">
      <center><h4>‚åû ‚åù Capturas ‚åû ‚åù</h4></center>
      <center><button id="captureBtn" class="btn ghost" style="margin-bottom:8px;">Capturar (Ctrl+Shift+X)</button>
      <div id="imageList"></div>
    </div>
  </div>

  <div style="flex:1;margin-top:12px;">
  <center><h4>üé• Videos üé•</h4></center>
  <center><button id="recordVideo" class="btn ghost" style="margin-bottom:8px;">Grabar Video</button></center>
  <div id="videoList"></div>
</div>


  </div>
</div>

<!-- Modal de carga masiva -->
<div id="bulkModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bulk-title">
  <div class="box">
    <center><h2 id="bulk-title">Carga masiva de informes</h2></center>
    <center><p class="sub" style="margin:0 0 10px">Peg√° <b>una URL por l√≠nea</b>.</p></center>
    <div class="note-wrap">
      <label for="bulkArea">Lista de URLs</label>
      <textarea id="bulkArea" placeholder="https://example.com/report/123"></textarea>
      <label><input id="bulkTrimEmpty" type="checkbox" checked> Ignorar l√≠neas vac√≠as</label>
    </div>
    <div class="actions">
      <button id="bulkCreate" class="btn">Crear (Ctrl+Enter)</button>
      <button id="bulkCancel" class="btn ghost">Cancelar</button>
    </div>
  </div>
</div>

<div id="tooltip" role="tooltip" aria-hidden="true"></div>


<!-- Visor modal para im√°genes ampliadas -->
<div id="imgViewer">
  <button id="closeImg">Cerrar</button>
  <img id="viewerImg" src="">
</div>

<script>
(function(){
  const KEY = 'aquiles_payloads_data_v1';
  const UIKEY = 'aquiles_payloads_ui_filters_v1';
  const catsEl = document.getElementById('cats');

  function uid(){ return Math.random().toString(36).slice(2,9); }
  function load(){
    try{ const o = JSON.parse(localStorage.getItem(KEY)||''); if(o && Array.isArray(o.cats)) return o; }catch{}
    return { cats:[{id:uid(),title:'XSS',items:[]},{id:uid(),title:'IDOR',items:[]},{id:uid(),title:'RCE',items:[]}] };
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  let state = load();

  // filtros
  let filters = loadFilters();
  function loadFilters(){ try{ return JSON.parse(localStorage.getItem(UIKEY)||'{}'); }catch{ return {}; } }
  function getFilter(catId){ return filters[catId] || { text:'', state:'all' }; }
  function setFilter(catId, patch){
    filters[catId] = { ...getFilter(catId), ...patch };
    localStorage.setItem(UIKEY, JSON.stringify(filters));
    render();
  }

  // estados
  const STATUS_SET = [
    {id:'monton',text:'Informe del mont√≥n',cls:'pill-monton'},
    {id:'regular',text:'Informe regular',cls:'pill-regular'},
    {id:'buen',text:'Informe bueno',cls:'pill-buen'},
    {id:'muybueno',text:'Informe muy bueno',cls:'pill-muybueno'},
    {id:'excelente',text:'Informe excelente',cls:'pill-excelente'},
    {id:'urgente',text:'Leer inmediatamente',cls:'pill-urgente'},
    {id:'luego',text:'Leer m√°s tarde',cls:'pill-luego'}
  ];
  function statusObj(id){ return STATUS_SET.find(s=>s.id===id)||null; }

  // tooltip
  const $tt = document.getElementById('tooltip');
  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function tipHtml(item) {
  const title = escapeHtml(item.title || 'Informe');
  let noteText = (item.note || '').trim();

  // Limitar a 40 l√≠neas para no romper la UX
  const lines = noteText.split(/\r?\n/);
  if (lines.length > 10) {
    noteText = lines.slice(0, 10).join('\n') + '\n[...] (contenido truncado)';
  }

  const body = noteText
    ? escapeHtml(noteText).replace(/\n/g, '<br>')
    : '<i>Sin nota</i>';

  // Estado de multimedia
  const hasAudio = item.audios && item.audios.length > 0 ? 'üëç' : '‚ùå';
  const hasImg = item.images && item.images.length > 0 ? 'üëç' : '‚ùå';
  const hasVideo = item.videos && item.videos.length > 0 ? 'üëç' : '‚ùå';

    // Metadatos con salto de l√≠nea
  const metaLines = [];
  if (item.editedTs)
    metaLines.push(`√öltima edici√≥n: ${new Date(item.editedTs).toLocaleString()}`);
  metaLines.push(`Audio: ${hasAudio}`);
  metaLines.push(`Captura: ${hasImg}`);
  metaLines.push(`Video: ${hasVideo}`);

  const meta = `<div class="tt-meta">${metaLines.join('<br>')}</div>`;
  return `<div class="tt-title">${title}</div><div class="tt-body">${body}</div>${meta}`;
}

  // === TOOLTIP (hover sobre informes) ===
let isMouseDown = false;
window.addEventListener('mousedown', () => isMouseDown = true);
window.addEventListener('mouseup', () => isMouseDown = false);

function showTip(html, x, y) {
  if (isMouseDown) return; // no mostrar mientras se hace click o drag
  $tt.innerHTML = html;
  $tt.classList.add('show');
  positionTip(x, y);
  $tt.setAttribute('aria-hidden', 'false');
}

function moveTip(x, y) {
  if ($tt.classList.contains('show'))
    positionTip(x, y);
}

function hideTip() {
  $tt.classList.remove('show');
  $tt.setAttribute('aria-hidden', 'true');
}

function positionTip(x, y) {
  const pad = 10, off = 16, mw = $tt.offsetWidth, mh = $tt.offsetHeight;
  let left = x + off, top = y + off;
  if (left + mw > innerWidth - pad) left = x - mw - off;
  if (left < pad) left = pad;
  if (top + mh > innerHeight - pad) top = y - mh - off;
  if (top < pad) top = pad;
  $tt.style.left = left + 'px';
  $tt.style.top = top + 'px';
}

function bindNoteTooltip(el, item) {
  el.addEventListener('mouseenter', e => {
    if (isMouseDown) return;
    showTip(tipHtml(item), e.clientX, e.clientY);
  });
  el.addEventListener('mousemove', e => {
    if (isMouseDown) hideTip();
    else moveTip(e.clientX, e.clientY);
  });
  el.addEventListener('mouseleave', hideTip);
}


  // helpers
  function getCI(catId,itemId){
    const cat=state.cats.find(c=>c.id===catId);
    const item=cat?cat.items.find(i=>i.id===itemId):null;
    return {cat,item};
  }
  function selectAll(el){const r=document.createRange();r.selectNodeContents(el);const s=window.getSelection();s.removeAllRanges();s.addRange(r);}

  // urls
  function toHttpUrl(v){
    const s=(v||'').trim();if(!s)return null;
    try{const withProto=/^https?:\/\//i.test(s)?s:'http://'+s;const u=new URL(withProto);return u.href;}catch{return null;}
  }
  function openOne(urlStr){
    const u=toHttpUrl(urlStr);if(!u){alert('URL inv√°lida o vac√≠a.');return false;}
    window.open(u,'_blank','noopener,noreferrer');return true;
  }

  // render
  function render(){
    catsEl.innerHTML='';
    state.cats.forEach(cat=>{
      const wrap=document.createElement('section');wrap.className='category';wrap.dataset.id=cat.id;
      const head=document.createElement('div');head.className='chead';
      const title = document.createElement('h2');
title.className = 'ctitle';
const flt = getFilter(cat.id);
const visibleItems = (cat.items || []).filter(it => matchItem(it, flt));
title.textContent = `${cat.title} (${visibleItems.length}/${cat.items?.length || 0})`;
title.title = 'Click para desplegar / Doble click para renombrar';

// Estado inicial de expansi√≥n por categor√≠a (persistente)
if (cat.collapsed === undefined) cat.collapsed = false;

// Al hacer click ‚Üí alternar visibilidad
title.addEventListener('click', e => {
  if (e.detail === 1) { // simple click ‚Üí colapsar/expandir
    cat.collapsed = !cat.collapsed;
    save();
    render();
  }
});

// Doble click ‚Üí editar nombre
title.addEventListener('dblclick', e => {
  e.stopPropagation();
  editCatTitle(title, cat);
});


      const fwrap=document.createElement('div');fwrap.className='cfilters';
      const fState=document.createElement('select');fState.className='cfilter-select';
      fState.innerHTML=`<option value="all">Estado: todos</option><option value="none">Sin etiqueta</option>${STATUS_SET.map(s=>`<option value="${s.id}">${s.text}</option>`).join('')}`;
      const curF=getFilter(cat.id);fState.value=curF.state;
      fState.addEventListener('change',()=>setFilter(cat.id,{state:fState.value}));
      const fText=document.createElement('input');
fText.className='cfilter-input';
fText.placeholder='Filtrar por texto‚Ä¶';
fText.value=curF.text;
fText.addEventListener('input',()=>setFilter(cat.id,{text:fText.value.trim().toLowerCase()}));


// === NUEVO: Buscador global de categor√≠as ===
const catSearch = document.createElement('input');
catSearch.className = 'cfilter-input';
catSearch.placeholder = 'Buscar categor√≠a‚Ä¶';
catSearch.style.width = '160px';
catSearch.title = 'Escrib√≠ el nombre de una categor√≠a y presion√° Enter';

// Estilo de resaltado temporal cuando salta a la categor√≠a
const highlightStyle = document.createElement('style');
highlightStyle.textContent = `
@keyframes catHighlight {
  0% { box-shadow: 0 0 0px 0px #b00; }
  50% { box-shadow: 0 0 15px 3px #b00; }
  100% { box-shadow: 0 0 0px 0px transparent; }
}
.category.highlighted {
  animation: catHighlight 1.6s ease;
}
`;
document.head.appendChild(highlightStyle);

// l√≥gica del buscador
catSearch.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const term = catSearch.value.trim().toLowerCase();
    if (!term) return;

    const matches = state.cats.filter(c => c.title.toLowerCase().includes(term));

    if (matches.length === 0) {
      alert(`No se encontr√≥ ninguna categor√≠a con el nombre "${term}".`);
      return;
    }

    if (matches.length === 1) {
      focusCat(matches[0]);
    } else {
      // === POPUP DE SELECCI√ìN ===
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(0,0,0,0.7)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '10000';

      const box = document.createElement('div');
      box.style.background = '#000';
      box.style.border = '1px solid #b00';
      box.style.borderRadius = '10px';
      box.style.padding = '15px 20px';
      box.style.color = '#fff';
      box.style.maxWidth = '320px';
      box.style.boxShadow = '0 0 20px rgba(255,0,0,0.4)';
      box.innerHTML = `<h3 style="margin-top:0;text-align:center;">Seleccion√° categor√≠a</h3>`;

      matches.forEach(c => {
        const btn = document.createElement('button');
        btn.textContent = c.title;
        btn.style.display = 'block';
        btn.style.margin = '8px auto';
        btn.className = 'btn ghost';
        btn.onclick = () => {
          overlay.remove();
          focusCat(c);
        };
        box.appendChild(btn);
      });

      const cancel = document.createElement('button');
      cancel.textContent = 'Cancelar';
      cancel.className = 'btn';
      cancel.style.marginTop = '10px';
      cancel.style.display = 'block';
      cancel.style.width = '100%';
      cancel.onclick = () => overlay.remove();
      box.appendChild(cancel);

      overlay.appendChild(box);
      document.body.appendChild(overlay);
    }
  }
});

// === FUNCIONALIDAD DE FOCO Y RESALTE ===
function focusCat(cat) {
  cat.collapsed = false; // expandir si estaba cerrada
  save();
  render();

  // scroll suave hacia la categor√≠a
  const el = document.querySelector(`section.category[data-id="${cat.id}"]`);
  if (el) {
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    el.classList.add('highlighted');
    setTimeout(() => el.classList.remove('highlighted'), 1600);
  }
}



// === reemplazar la creaci√≥n original de gSearch por este bloque ===
const gSearchWrap = document.createElement('div');
gSearchWrap.style.display = 'flex';
gSearchWrap.style.gap = '6px';
gSearchWrap.style.alignItems = 'center';

// input de b√∫squeda global (mismo estilo)
const gSearch = document.createElement('input');
gSearch.className = 'cfilter-input';
gSearch.placeholder = 'Plataformas informes ';
gSearch.style.width = '160px';

// select de plataformas / dorks (Freedium = 1)
const platformSelect = document.createElement('select');
platformSelect.className = 'cfilter-select';
platformSelect.style.minWidth = '160px';
platformSelect.title = 'Seleccion√° la plataforma / dork';
platformSelect.innerHTML = `
  <option value="all">Todas las plataformas</option>
  <option value="freedium">1 - Freedium</option>
  <option value="medium">2 - Medium / InfoSecWriteups</option>
  <option value="hacktivity">3 - Hacktivity (HackerOne)</option>
  <option value="bugreader">4 - BugReader</option>
  <option value="github">5 - GitHub (writeups / b√∫squeda)</option>
  <option value="reddit">6 - Reddit /r/bugbounty</option>
  <option value="pentester">7 - Pentester.land</option>
  <option value="launchpad">8 - Launchpad (bugs)</option>
  <option value="google">9 - Google</option>
`;

// botones
const openBtn = document.createElement('button');
openBtn.className = 'btn';
openBtn.textContent = 'Abrir';
openBtn.title = 'Abrir b√∫squeda en la plataforma seleccionada';

const openAllBtn = document.createElement('button');
openAllBtn.className = 'btn ghost';
openAllBtn.textContent = 'Abrir todas';
openAllBtn.title = 'Abrir b√∫squeda en todas las plataformas (varias pesta√±as)';

// a√±adir a wrapper
gSearchWrap.append(gSearch, platformSelect, openBtn, openAllBtn);
fwrap.append(fState, fText, catSearch, gSearchWrap); // reemplaza la l√≠nea previa que a√±ad√≠a gSearch solo

// --- plantillas de URLs (usa {q} como placeholder) ---
const PLATFORM_TEMPLATES = {
  freedium: 'https://freedium.cfd/', // Freedium (opci√≥n a√±adida)
  medium: 'https://infosecwriteups.com/search?q={q}',
  hacktivity: 'https://hackerone.com/hacktivity/overview?queryString={q}&sortField=latest_disclosable_activity_at&sortDirection=DESC&pageIndex=1',
  bugreader: 'https://bugreader.com/reports?search={q}', // plantilla gen√©rica
  github: 'https://github.com/rix4uni/medium-writeups/',
  reddit: 'https://www.reddit.com/r/bugbounty/search?q={q}&restrict_sr=on',
  pentester: 'https://pentester.land/writeups/?s={q}',
  launchpad: 'https://bugs.launchpad.net/bugs/+bugs?field.searchtext={q}&search=Search&field.status%3Alist=NEW&field.status%3Alist=INCOMPLETE_WITH_RESPONSE&field.status%3Alist=INCOMPLETE_WITHOUT_RESPONSE&field.status%3Alist=CONFIRMED&field.status%3Alist=TRIAGED&field.status%3Alist=INPROGRESS&field.status%3Alist=DEFERRED&field.status%3Alist=FIXCOMMITTED&field.assignee=&field.bug_reporter=&field.omit_dupes=on&field.has_patch=&field.has_no_package=' ,
  google: 'https://www.google.com/search?q={q}',

};

// helper: construye URL desde template y t√©rmino
function buildPlatformUrl(template, term) {
  const qEncoded = encodeURIComponent(term.trim());
  return template.replaceAll('{q}', qEncoded);
}

// acci√≥n: abrir la plataforma seleccionada
openBtn.addEventListener('click', () => {
  const term = gSearch.value.trim();
  if (!term) { alert('Ingres√° un t√©rmino de b√∫squeda (p. ej. xss)'); return; }

  const sel = platformSelect.value;
  if (sel === 'all') {
    // si seleccion√≥ 'Todas' abrimos todas (misma l√≥gica que openAllBtn)
    openAllForTerm(term);
    return;
  }

  const tpl = PLATFORM_TEMPLATES[sel];
  if (!tpl) { alert('Plataforma inv√°lida'); return; }
  const url = buildPlatformUrl(tpl, term);
  window.open(url, '_blank', 'noopener,noreferrer');
});

// acci√≥n: abrir todas las plataformas (varias pesta√±as)
function openAllForTerm(term) {
  const t = term.trim();
  if (!t) { alert('Ingres√° un t√©rmino de b√∫squeda (p. ej. xss)'); return; }
  // aviso simple si el navegador puede bloquear muchas pesta√±as
  const confirmed = confirm('Se van a abrir varias pesta√±as (una por plataforma). ¬øContinuar?');
  if (!confirmed) return;

  Object.keys(PLATFORM_TEMPLATES).forEach(key => {
    const tpl = PLATFORM_TEMPLATES[key];
    const url = buildPlatformUrl(tpl, t);
    window.open(url, '_blank', 'noopener,noreferrer');
  });
}

openAllBtn.addEventListener('click', () => {
  const term = gSearch.value.trim();
  openAllForTerm(term);
});

// tambi√©n: Enter en el input ejecuta la acci√≥n de abrir la plataforma seleccionada
gSearch.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    openBtn.click();
  }
});




      const actions=document.createElement('div');actions.className='cactions';
      // Botones de acciones dentro de cada categor√≠a
const addItemBtn = btn('+ Agregar', () => addItem(cat.id));
const addCatBtn = btn('+ Nueva categor√≠a', addCategory); // ‚Üê agregado aqu√≠
const delCatBtn = btn('Eliminar categor√≠a', () => delCat(cat.id), true);
const bulkBtn = btn('Carga masiva', () => openBulk(cat.id));
const copyUrlsBtn = btn('Copiar URLs', () => copyUrls(cat.id), true);
const copyNotesBtn = btn('Copiar Notas', () => copyNotes(cat.id), true);
const exportBtn = btn('Exportar JSON', () => exportCat(cat.id), true);
const importBtn = btn('Importar JSON', () => importCat(cat.id), true);

// Orden: Nueva categor√≠a primero, luego Agregar, etc.
// Agregar tambi√©n los botones globales aqu√≠
const exportSelectedBtn = btn('Exportar seleccionadas', exportSelectedCats);
const importFullCatsBtn = btn('Importar categor√≠as completas', importFullCats, true);

actions.append(
  addItemBtn, addCatBtn, delCatBtn, bulkBtn,
  copyUrlsBtn, copyNotesBtn, exportBtn, importBtn,
  exportSelectedBtn, importFullCatsBtn
);

// Checkbox de selecci√≥n para exportaci√≥n m√∫ltiple
const selBox = document.createElement('input');
selBox.type = 'checkbox';
selBox.className = 'cat-select';
selBox.dataset.id = cat.id;
selBox.title = 'Incluir esta categor√≠a al exportar seleccionadas';
head.prepend(selBox);

      head.append(title,fwrap,actions);wrap.appendChild(head);

      const list = document.createElement('div');
list.className = 'items';
const visible = (cat.items || []).filter(it => matchItem(it, flt));

// Si la categor√≠a est√° colapsada ‚Üí ocultar con transici√≥n suave
if (cat.collapsed) {
  list.style.display = 'none';
} else {
  list.style.display = 'flex';
  list.style.flexDirection = 'column';
  list.style.gap = '6px';
  visible.forEach(item => {
    const row = document.createElement('div');
    row.className = 'item';
    row.dataset.item = item.id;
    if ((item.note || '').trim()) row.classList.add('note');

    const left = document.createElement('div');
    left.className = 'row-left';
    const ititle = document.createElement('div');
    ititle.className = 'ititle';
    ititle.textContent = item.title || 'Nuevo informe';
    ititle.addEventListener('click', e => { e.stopPropagation(); editItemTitle(ititle, cat.id, item.id); });
    const pill = renderStatusPill(cat.id, item.id);
    left.append(ititle, pill);

    const linkB = document.createElement('div');
    linkB.className = 'linkbox';
    const ipayload = document.createElement('input');
    ipayload.className = 'ipayload';
    ipayload.type = 'text';
    ipayload.placeholder = 'URL del informe';
    ipayload.value = item.payload || '';
    ipayload.addEventListener('change', () => { item.payload = ipayload.value; save(); });
    const openBtn = document.createElement('button');
    openBtn.className = 'btn open';
    openBtn.textContent = 'Abrir';
    openBtn.addEventListener('click', () => {
      const v = (item.payload || '').trim();
      if (!v) { alert('Sin URL'); return; }
      openOne(v);
    });
    linkB.append(ipayload, openBtn);

    const tools = document.createElement('div');
    tools.style.display = 'flex';
    tools.style.gap = '6px';
    const noteBtn = btn('Nota', () => openNote(cat.id, item.id), false);
    const delBtn = btn('Borrar', () => delItem(cat.id, item.id), true);
    tools.append(noteBtn, delBtn);

    row.append(left, linkB, tools);
    bindNoteTooltip(row, item);
    bindNoteTooltip(noteBtn, item);
    row.addEventListener('click', e => {
      const t = e.target.tagName.toLowerCase();
      if (['input', 'button', 'a'].includes(t) || e.target.classList.contains('pill') || e.target.classList.contains('ititle')) return;
      openNote(cat.id, item.id);
    });
    list.appendChild(row);
  });
}

wrap.appendChild(list);
catsEl.appendChild(wrap);
    });
  }

  function matchItem(item,flt){
    const textOk=!flt.text||(`${item.title} ${item.payload||''} ${item.note||''}`).toLowerCase().includes(flt.text);
    const stateOk=flt.state==='all'?true:flt.state==='none'?!item.status:item.status===flt.state;
    return textOk&&stateOk;
  }
  function btn(txt,fn,ghost=false){const b=document.createElement('button');b.className='btn'+(ghost?' ghost':'');b.textContent=txt;b.onclick=fn;return b;}

  function renderStatusPill(catId,itemId){
    const {item}=getCI(catId,itemId);
    const s=statusObj(item.status);
    const btn=document.createElement('button');btn.className='pill '+(s?s.cls:'pill-none');
    btn.textContent=s?s.text:'Estado';
    btn.onclick=e=>openStatusMenu(btn,catId,itemId);
    return btn;
  }
  function openStatusMenu(anchor,catId,itemId){
    closeMenus();
    const menu=document.createElement('ul');menu.className='label-menu';
    const add=(id,text,cls)=>{const li=document.createElement('li');li.innerHTML=`<span class="pill ${cls}">${text}</span>`;li.onclick=()=>{setStatus(catId,itemId,id);closeMenus();};menu.appendChild(li);};
    add(null,'Sin etiqueta','pill-none');STATUS_SET.forEach(s=>add(s.id,s.text,s.cls));
    document.body.appendChild(menu);
    requestAnimationFrame(()=>{const r=anchor.getBoundingClientRect();menu.style.left=r.left+'px';menu.style.top=r.bottom+'px';});
    document.addEventListener('mousedown',e=>{if(!menu.contains(e.target)&&e.target!==anchor)closeMenus();},{once:true});
  }
  function closeMenus(){document.querySelectorAll('.label-menu').forEach(m=>m.remove());}
  function setStatus(catId,itemId,status){const {item}=getCI(catId,itemId);if(!item)return;item.status=status||null;save();render();}

  function editCatTitle(el,cat){
    el.contentEditable='true';el.focus();selectAll(el);
    el.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();el.blur();}};
    el.onblur=()=>{cat.title=(el.textContent||'').replace(/\(\d+\)\s*$/,'').trim()||'Sin nombre';save();render();};
  }
  function editItemTitle(el,catId,itemId){
    const {item}=getCI(catId,itemId);if(!item)return;
    el.contentEditable='true';el.focus();selectAll(el);
    el.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();el.blur();}};
    el.onblur=()=>{item.title=(el.textContent||'').trim()||'Nuevo informe';save();render();};
  }

  function addCategory(){const name=prompt('Nombre de la categor√≠a:','Nueva categor√≠a');if(name===null)return;
    state.cats.push({id:uid(),title:name.trim()||'Nueva categor√≠a',items:[]});save();render();}
  function addItem(catId){const cat=state.cats.find(c=>c.id===catId);if(!cat)return;
    cat.items.push({id:uid(),title:'ü¶Ö Nuevo informe ü¶Ö',payload:'',note:'',editedTs:0,status:null});save();render();}
  // =================== NUEVAS FUNCIONES ===================

// Muestra un popup de confirmaci√≥n moderno
function confirmarAccion(titulo, mensaje) {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.background = 'rgba(0,0,0,0.7)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '99999';

    const box = document.createElement('div');
    box.style.background = '#000';
    box.style.color = '#fff';
    box.style.padding = '20px';
    box.style.borderRadius = '10px';
    box.style.border = '1px solid #b00';
    box.style.textAlign = 'center';
    box.style.width = '280px';
    box.style.boxShadow = '0 0 12px rgba(255,0,0,0.4)';

    const h2 = document.createElement('h3');
    h2.textContent = titulo;
    const p = document.createElement('p');
    p.textContent = mensaje;
    p.style.margin = '15px 0';

    const btns = document.createElement('div');
    btns.style.display = 'flex';
    btns.style.justifyContent = 'center';
    btns.style.gap = '10px';

    const yes = document.createElement('button');
    yes.textContent = 'S√≠';
    yes.className = 'btn';
    const no = document.createElement('button');
    no.textContent = 'No';
    no.className = 'btn ghost';

    yes.onclick = () => { overlay.remove(); resolve(true); };
    no.onclick = () => { overlay.remove(); resolve(false); };

    btns.append(yes, no);
    box.append(h2, p, btns);
    overlay.append(box);
    document.body.append(overlay);
  });
}

// Nueva funci√≥n de eliminar categor√≠a
async function delCat(catId) {
  const cat = state.cats.find(c => c.id === catId);
  if (!cat) return;
  const ok = await confirmarAccion('Eliminar categor√≠a', `¬øEliminar la categor√≠a "${cat.title}" completa?`);
  if (!ok) return;
  state.cats = state.cats.filter(c => c.id !== catId);
  save();
  render();
}

// Nueva funci√≥n de eliminar informe
async function delItem(catId, itemId) {
  const cat = state.cats.find(c => c.id === catId);
  if (!cat) return;
  const item = cat.items.find(i => i.id === itemId);
  if (!item) return;
  const ok = await confirmarAccion('Eliminar informe', `¬øEliminar el informe "${item.title}"?`);
  if (!ok) return;
  cat.items = cat.items.filter(i => i.id !== itemId);
  save();
  render();
}


  // notas
  const $modal=document.getElementById('modal');
  const $noteArea=document.getElementById('noteArea');
  const $metaInfo=document.getElementById('metaInfo');
  const $saveNote=document.getElementById('saveNote');
  const $clearNote=document.getElementById('clearNote');
  const $close=document.getElementById('close');
  let active={catId:null,itemId:null};

  function openNote(catId,itemId){
  const {item}=getCI(catId,itemId);if(!item)return;
  active={catId,itemId};
  document.getElementById('mod-title').textContent='  '+(item.title||'Informe');
  document.getElementById('noteLabel').textContent=' '+(item.title||'Informe');
  $noteArea.value=item.note||'';
  $metaInfo.textContent=item.editedTs?('√öltima edici√≥n: '+new Date(item.editedTs).toLocaleString()):'‚Äî';
  $modal.classList.add('open');hideTip();setTimeout(()=>{$noteArea.focus();},0);

 // === NUEVO: renderizar multimedia ===
renderMedia(item);

}

  function closeNote(){$modal.classList.remove('open');}
  $saveNote.onclick=()=>{const {item}=getCI(active.catId,active.itemId);if(!item)return;
    item.note=$noteArea.value.trim();item.editedTs=Date.now();save();closeNote();render();};
  $clearNote.onclick=()=>{if(!confirm('¬øBorrar nota?'))return;
    const {item}=getCI(active.catId,active.itemId);if(!item)return;
    item.note='';item.editedTs=0;save();closeNote();render();};
  $close.onclick=closeNote;
  $modal.onclick=e=>{if(e.target===$modal)closeNote();};
  window.addEventListener('keydown',e=>{if($modal.classList.contains('open')){if(e.key==='Escape')closeNote();if(e.ctrlKey&&e.key.toLowerCase()==='s'){e.preventDefault();$saveNote.click();}}});

  // carga masiva
  const $bulkModal=document.getElementById('bulkModal');
  const $bulkArea=document.getElementById('bulkArea');
  const $bulkTrimEmpty=document.getElementById('bulkTrimEmpty');
  const $bulkCreate=document.getElementById('bulkCreate');
  const $bulkCancel=document.getElementById('bulkCancel');
  let bulkTargetCatId=null;
  function openBulk(catId){bulkTargetCatId=catId;$bulkArea.value='';$bulkModal.classList.add('open');setTimeout(()=>{$bulkArea.focus();},0);}
  function closeBulk(){$bulkModal.classList.remove('open');bulkTargetCatId=null;}
  $bulkCancel.onclick=closeBulk;
  $bulkCreate.onclick=doBulkCreate;
  window.addEventListener('keydown',e=>{if($bulkModal.classList.contains('open')&&e.ctrlKey&&e.key.toLowerCase()==='enter'){e.preventDefault();doBulkCreate();}});
  function doBulkCreate(){
    const cat=state.cats.find(c=>c.id===bulkTargetCatId);if(!cat){closeBulk();return;}
    let lines=$bulkArea.value.replace(/\r/g,'\n').split('\n');
    if($bulkTrimEmpty.checked)lines=lines.map(l=>l.trim()).filter(l=>l.length>0);
    if(!lines.length){alert('No hay l√≠neas');return;}
    const toCreate=lines.slice(0,5000);
    toCreate.forEach((payload,idx)=>{
      cat.items.push({id:uid(),title:`Informe ${idx+1}`,payload:payload,note:'',editedTs:0,status:null});
    });
    save();closeBulk();render();alert(`Creados ${toCreate.length} informes en "${cat.title}".`);
  }

  // copiar
  function copyUrls(catId){const cat=state.cats.find(c=>c.id===catId);if(!cat)return;
    const flt=getFilter(cat.id);
    const vals=(cat.items||[]).filter(i=>matchItem(i,flt)).map(i=>(i.payload||'').trim()).filter(u=>u.length>0);
    navigator.clipboard.writeText(vals.join('\n'));alert(`Copiadas ${vals.length} URLs de "${cat.title}".`);}
  function copyNotes(catId){const cat=state.cats.find(c=>c.id===catId);if(!cat)return;
    const flt=getFilter(cat.id);
    const vals=(cat.items||[]).filter(i=>matchItem(i,flt)).map(i=>(i.note||'').trim()).filter(u=>u.length>0);
    navigator.clipboard.writeText(vals.join('\n'));alert(`Copiadas ${vals.length} notas de "${cat.title}".`);}

  // export/import
  function exportCat(catId){
    const cat=state.cats.find(c=>c.id===catId);if(!cat)return;
    const blob=new Blob([JSON.stringify(cat,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${cat.title}.json`;a.click();
  }
  function importCat(catId) {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.json,application/json';
  inp.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        const cat = state.cats.find(c => c.id === catId);
        if (!cat) throw new Error('Categor√≠a no encontrada');
        if (!Array.isArray(data.items)) throw new Error('Archivo sin items v√°lidos');

        // === NUEVO: fusiona en lugar de reemplazar ===
        const existingIds = new Set(cat.items.map(i => i.id));
        let added = 0;

        (data.items || []).forEach(it => {
          // evita duplicados por id o por payload
          if (!existingIds.has(it.id) && !cat.items.some(x => x.payload === it.payload)) {
            cat.items.push({
              ...it,
              id: it.id || uid(),
              title: it.title || 'Informe importado',
              note: it.note || '',
              payload: it.payload || '',
              status: it.status || null,
              audios: it.audios || [],
              images: it.images || [],
              videos: it.videos || []
            });
            added++;
          }
        });

        save();
        render();
        alert(`Importados ${added} nuevos informes en "${cat.title}". Los existentes se conservaron.`);
      } catch (err) {
        alert('Archivo inv√°lido o error al fusionar.');
        console.error(err);
      }
    };
    reader.readAsText(file);
  };
  inp.click();
}




// === EXPORTAR SOLO CATEGOR√çAS SELECCIONADAS ===
function exportSelectedCats() {
  // obtener ids marcados
  const selected = [...document.querySelectorAll('.cat-select:checked')].map(c => c.dataset.id);
  if (!selected.length) { alert('Seleccion√° al menos una categor√≠a.'); return; }

  const toExport = {
    cats: state.cats.filter(c => selected.includes(c.id))
  };

  const blob = new Blob([JSON.stringify(toExport, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `categorias_seleccionadas.json`;
  a.click();
}



// === IMPORTAR CATEGOR√çAS COMPLETAS DESDE JSON ===
function importFullCats() {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.json,application/json';
  inp.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (!data.cats || !Array.isArray(data.cats)) {
          alert('El archivo no contiene categor√≠as v√°lidas.');
          return;
        }

        let added = 0;
        data.cats.forEach(cat => {
          // Evita duplicar por t√≠tulo exacto
          if (!state.cats.some(c => c.title === cat.title)) {
            state.cats.push({
              id: uid(),
              title: cat.title || 'Categor√≠a importada',
              items: (cat.items || []).map(it => ({
                id: uid(),
                title: it.title || 'Informe importado',
                payload: it.payload || '',
                note: it.note || '',
                status: it.status || null,
                audios: it.audios || [],
                images: it.images || [],
                videos: it.videos || [],
                editedTs: it.editedTs || 0
              }))
            });
            added++;
          }
        });

        save();
        render();
        alert(`Importadas ${added} nuevas categor√≠as completas.`);
      } catch (err) {
        alert('Archivo inv√°lido o error al importar.');
        console.error(err);
      }
    };
    reader.readAsText(file);
  };
  inp.click();
}





  // === MULTIMEDIA (Audio + Captura) ===
// === VIDEO ===
const videoList = document.getElementById('videoList');
const recordVideoBtn = document.getElementById('recordVideo');
let videoRecorder, videoChunks = [];

recordVideoBtn.onclick = async () => {
  const { item } = getCI(active.catId, active.itemId);
  if (!item.videos) item.videos = [];

  if (videoRecorder && videoRecorder.state === 'recording') {
    videoRecorder.stop();
    recordVideoBtn.textContent = 'Grabar Video';
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
    videoRecorder = new MediaRecorder(stream);
    videoChunks = [];

    videoRecorder.ondataavailable = e => videoChunks.push(e.data);
    videoRecorder.onstop = () => {
      const blob = new Blob(videoChunks, { type: 'video/webm' });
      const reader = new FileReader();
      reader.onloadend = () => {
        item.videos.push(reader.result);
        save();
        renderMedia(item);
      };
      reader.readAsDataURL(blob);
      stream.getTracks().forEach(t => t.stop());
    };

    videoRecorder.start();
    recordVideoBtn.textContent = '‚èπÔ∏è Detener';
  } catch {
    alert('No se pudo acceder a c√°mara o micr√≥fono.');
  }
};



const audioList = document.getElementById('audioList');
const imageList = document.getElementById('imageList');
const recordBtn = document.getElementById('recordAudio');
const captureBtn = document.getElementById('captureBtn');

let mediaRecorder, audioChunks = [];

function renderMedia(item) {
  // === AUDIOS con scroll ===
  audioList.innerHTML = '';
  (item.audios || []).forEach((src, idx) => {
    const wrap = document.createElement('div');
    wrap.style.marginBottom = '8px';
    const audio = document.createElement('audio');
    audio.controls = true;
    audio.src = src;
    audio.style.width = '100%';

    const del = document.createElement('button');
    del.textContent = 'Borrar';
    del.className = 'btn ghost';
    del.style.marginTop = '4px';
    del.onclick = () => {
      item.audios.splice(idx, 1);
      save();
      renderMedia(item);
    };

    wrap.appendChild(audio);
    wrap.appendChild(del);
    audioList.appendChild(wrap);
  });

  // === IM√ÅGENES con scroll y doble clic ===
  imageList.innerHTML = '';
  (item.images || []).forEach((src, idx) => {
    const wrap = document.createElement('div');
    wrap.style.marginBottom = '8px';

    const img = document.createElement('img');
    img.src = src;
    img.style.maxWidth = '100%';
    img.style.borderRadius = '6px';
    img.style.cursor = 'zoom-in';
    img.ondblclick = () => openImageViewer(src);

    const del = document.createElement('button');
    del.textContent = 'Borrar';
    del.className = 'btn ghost';
    del.style.marginTop = '4px';
    del.onclick = () => {
      item.images.splice(idx, 1);
      save();
      renderMedia(item);
    };

    wrap.appendChild(img);
    wrap.appendChild(del);
    imageList.appendChild(wrap);
  });


// === VIDEOS con scroll ===
videoList.innerHTML = '';
(item.videos || []).forEach((src, idx) => {
  const wrap = document.createElement('div');
  wrap.style.marginBottom = '8px';
  const video = document.createElement('video');
  video.controls = true;
  video.src = src;
  video.style.width = '100%';

  const del = document.createElement('button');
  del.textContent = 'Borrar';
  del.className = 'btn ghost';
  del.style.marginTop = '4px';
  del.onclick = () => {
    item.videos.splice(idx, 1);
    save();
    renderMedia(item);
  };

  wrap.append(video, del);
  videoList.appendChild(wrap);
});

}




// === GRABACI√ìN DE AUDIO ===
recordBtn.onclick = async () => {
  const { item } = getCI(active.catId, active.itemId);
  if (!item.audios) item.audios = [];
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    recordBtn.textContent = 'Grabar Audio';
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const reader = new FileReader();
      reader.onloadend = () => {
        item.audios.push(reader.result);
        save();
        renderMedia(item);
      };
      reader.readAsDataURL(blob);
    };

    mediaRecorder.start();
    recordBtn.textContent = '‚èπÔ∏è Detener';
  } catch {
    alert('No se pudo acceder al micr√≥fono.');
  }
};

// === CAPTURA DE PANTALLA ===
captureBtn.onclick = async () => captureScreen();
window.addEventListener("keydown", e => {
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "x") {
    captureScreen();
  }
});

async function captureScreen() {
  const { item } = getCI(active.catId, active.itemId);
  if (!item.images) item.images = [];
  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const bitmap = await imageCapture.grabFrame();
    track.stop();

    const canvas = document.createElement('canvas');
    canvas.width = bitmap.width;
    canvas.height = bitmap.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(bitmap, 0, 0);

    const imgData = canvas.toDataURL('image/png');
    item.images.push(imgData);
    save();
    renderMedia(item);
  } catch {
    alert('No se pudo realizar la captura de pantalla.');
  }
}


// === VISOR DE IMAGEN AMPLIADA ===
const imgViewer = document.getElementById('imgViewer');
const viewerImg = document.getElementById('viewerImg');
const closeImg = document.getElementById('closeImg');

function openImageViewer(src) {
  viewerImg.src = src;
  imgViewer.classList.add('open');
}

closeImg.onclick = () => {
  imgViewer.classList.remove('open');
  viewerImg.src = '';
};

imgViewer.onclick = e => {
  if (e.target === imgViewer) {
    imgViewer.classList.remove('open');
    viewerImg.src = '';
  }
};



// === REORDENAR CATEGOR√çAS POR DRAG & DROP ===
function enableCatDrag() {
  let draggedEl = null;
  let startIndex = -1;

  catsEl.querySelectorAll('section.category').forEach((el, idx) => {
    el.draggable = true;
    el.style.cursor = 'grab';

    el.addEventListener('dragstart', e => {
      draggedEl = el;
      startIndex = idx;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', el.dataset.id);
      el.style.opacity = '0.4';
    });

    el.addEventListener('dragend', () => {
      el.style.opacity = '1';
      draggedEl = null;
    });

    el.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const rect = el.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      const after = e.clientY > midY;
      if (after) el.style.borderBottom = '2px solid #b00';
      else el.style.borderTop = '2px solid #b00';
    });

    el.addEventListener('dragleave', () => {
      el.style.borderTop = el.style.borderBottom = 'none';
    });

    el.addEventListener('drop', e => {
      e.preventDefault();
      el.style.borderTop = el.style.borderBottom = 'none';
      const id = e.dataTransfer.getData('text/plain');
      const draggedCat = state.cats.find(c => c.id === id);
      const targetId = el.dataset.id;
      const targetIndex = state.cats.findIndex(c => c.id === targetId);
      if (startIndex === -1 || targetIndex === -1 || !draggedCat) return;

      // quitar y reinsertar
      state.cats.splice(startIndex, 1);
      state.cats.splice(targetIndex, 0, draggedCat);
      save();
      render();
    });
  });
}

// === REORDENAR INFORMES DENTRO DE CADA CATEGOR√çA ===
function enableItemDrag() {
  document.querySelectorAll('section.category').forEach(section => {
    const catId = section.dataset.id;
    const cat = state.cats.find(c => c.id === catId);
    if (!cat || cat.collapsed) return;

    const list = section.querySelector('.items');
    if (!list) return;

    let draggedEl = null;
    let draggedId = null;

    list.querySelectorAll('.item').forEach(el => {
      el.draggable = true;
      el.style.cursor = 'grab';

      el.addEventListener('dragstart', e => {
        draggedEl = el;
        draggedId = el.dataset.item;
        e.dataTransfer.effectAllowed = 'move';
        try {
          e.dataTransfer.setData('text/plain', draggedId);
        } catch (err) {}
        el.style.opacity = '0.4';
      });

      el.addEventListener('dragend', () => {
        el.style.opacity = '1';
        draggedEl = null;
        draggedId = null;
        list.querySelectorAll('.item').forEach(i => {
          i.style.borderTop = i.style.borderBottom = 'none';
        });
      });

      el.addEventListener('dragover', e => {
        e.preventDefault();
        const rect = el.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        const after = e.clientY > midY;
        el.style.borderTop = after ? 'none' : '2px solid #b00';
        el.style.borderBottom = after ? '2px solid #b00' : 'none';
      });

      el.addEventListener('dragleave', () => {
        el.style.borderTop = el.style.borderBottom = 'none';
      });

      el.addEventListener('drop', e => {
        e.preventDefault();
        e.stopPropagation();
        el.style.borderTop = el.style.borderBottom = 'none';

        const targetId = el.dataset.item;
        if (!draggedId || draggedId === targetId) return;

        const draggedIndex = cat.items.findIndex(i => i.id === draggedId);
        const targetIndex = cat.items.findIndex(i => i.id === targetId);
        if (draggedIndex === -1 || targetIndex === -1) return;

        // mover el informe en el array
        const [moved] = cat.items.splice(draggedIndex, 1);
        cat.items.splice(targetIndex, 0, moved);
        save();
        render();

        // === NUEVO FIX: reactivar hover inmediatamente ===
        setTimeout(() => {
          const newEl = document.querySelector(`.item[data-item="${targetId}"]`);
          if (newEl) {
            const evt = new MouseEvent("mouseenter", { bubbles: true });
            newEl.dispatchEvent(evt);
          }
        }, 100);
      });
    });
  });
}




// hook: despu√©s de render, reactivar arrastre
const origRender = render;
render = function() {
  origRender();
  enableCatDrag();
  enableItemDrag(); // <-- activamos el drag interno de informes
};




  render();


  // Asegurar inicializaci√≥n de drag una vez renderizado todo el DOM
window.addEventListener('load', () => {
  enableCatDrag();
  enableItemDrag();
});


})();
</script>
</body>
</html>
